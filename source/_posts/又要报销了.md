---
title: åˆè¦æŠ¥é”€äº†ï¼Œè¿˜åœ¨æ‰‹åŠ¨ä¸‹è½½æ•´ç†å‘ç¥¨å—ï¼Ÿ
date: 2024-01-02 10:51:05
categories:
tags:
    - python
---

å¤§å¤šæ•°å…¬å¸éƒ½æ˜¯æ¯ä¸ªæœˆå®šæœŸæäº¤æŠ¥é”€ï¼Œä¸€èˆ¬æŠ¥é”€ç”¨çš„å‘ç¥¨éƒ½æ˜¯ç”µå­å‘ç¥¨å‘åˆ°é‚®ç®±ï¼Œæ¯æ¬¡è¦æŠ¥é”€æ—¶éƒ½éœ€è¦ç™»å½•é‚®ç®±ï¼Œç‚¹å¼€é‚®ä»¶ï¼Œä¸€ä¸ªä¸ªä¸‹è½½æ•´ç†ï¼Œå·¥ä½œé‡ä¸å¤§ï¼Œä½†æ˜¯å‘ç¥¨å¤šäº†ä¹Ÿç€å®å¾ˆçƒ¦ã€‚è¿™ä¸ªæœˆç»ˆäºä¸‹å†³å¿ƒæŠŠè¿™ä¸ªè¿‡ç¨‹è‡ªåŠ¨åŒ–ä¸€ä¸‹ã€‚

## æ€è·¯

æŸ¥çœ‹äº†ä¸€ä¸‹é‚®ç®±é‡Œçš„å‘ç¥¨é‚®ä»¶ï¼Œè™½ç„¶ä¸»é¢˜å†…å®¹æ ¼å¼ä¸å›ºå®šï¼Œä½†æ˜¯åŸºæœ¬éƒ½åŒ…å«â€œå‘ç¥¨â€ï¼Œæ‰€ä»¥å¯ä»¥ç”¨â€œå‘ç¥¨â€å…³é”®è¯å°†å‘ç¥¨é‚®ä»¶ç­›é€‰å‡ºæ¥ã€‚ç„¶åè§£æå‘ç¥¨é‚®ä»¶å†…å®¹ï¼Œå°†å‘ç¥¨pdfæ–‡ä»¶æå–ä¸‹è½½ï¼Œå¹¶æ•´ç†åˆ°æŒ‡å®šæ–‡ä»¶å¤¹ã€‚

å—¯ï¼Œå°±è¿™ä¹ˆç®€å•ã€‚

## å®ç°

è¿™ç§äº‹è¿˜æ˜¯ç”¨pythonæ¯”è¾ƒå¿«å§ï¼Œæèµ·ã€‚

<!-- more -->

### EMAILç›¸å…³åº“

åœ¨Pythonä¸­ï¼Œæœ‰ä¸€äº›å¸¸ç”¨çš„åº“å¯ä»¥ç”¨æ¥æ“ä½œå’Œå¤„ç†é‚®ä»¶ï¼ˆemailï¼‰ï¼š

1. **`smtplib` å’Œ `email` æ¨¡å—**ï¼š

   Pythonæ ‡å‡†åº“ä¸­çš„`smtplib`å’Œ`email`æ¨¡å—å¯ä»¥ç”¨æ¥å‘é€é‚®ä»¶ã€‚`smtplib`æ¨¡å—è´Ÿè´£è¿æ¥åˆ°SMTPæœåŠ¡å™¨å¹¶å‘é€é‚®ä»¶ï¼Œè€Œ`email`æ¨¡å—è´Ÿè´£åˆ›å»ºå’Œè§£æé‚®ä»¶å†…å®¹ã€‚è¿™ä¸¤ä¸ªæ¨¡å—ç»“åˆä½¿ç”¨å¯ä»¥å®ç°é‚®ä»¶çš„å‘é€ã€‚

   ç¤ºä¾‹ä»£ç ï¼š

   ```python
   import smtplib
   from email.message import EmailMessage

   msg = EmailMessage()
   msg.set_content('This is a test email sent from Python.')

   msg['Subject'] = 'Test Email'
   msg['From'] = 'sender@example.com'
   msg['To'] = 'recipient@example.com'

   server = smtplib.SMTP('smtp.example.com')
   server.send_message(msg)
   server.quit()
   ```

2. **`imaplib` å’Œ `poplib` æ¨¡å—**ï¼š

   Pythonçš„`imaplib`å’Œ`poplib`æ¨¡å—å¯ä»¥ç”¨æ¥æ¥æ”¶é‚®ä»¶ã€‚`imaplib`æ¨¡å—ç”¨äºè¿æ¥åˆ°IMAPæœåŠ¡å™¨ï¼Œè€Œ`poplib`æ¨¡å—ç”¨äºè¿æ¥åˆ°POP3æœåŠ¡å™¨ã€‚è¿™ä¸¤ä¸ªæ¨¡å—å¯ä»¥ç”¨æ¥æ£€ç´¢é‚®ä»¶ã€‚

   ç¤ºä¾‹ä»£ç ï¼š

   ```python
   import imaplib
   import email

   mail = imaplib.IMAP4_SSL('imap.example.com')
   mail.login('username', 'password')
   mail.select('inbox')

   status, messages = mail.search(None, 'ALL')
   messages = messages[0].split()

   for mail_id in messages:
       _, msg = mail.fetch(mail_id, '(RFC822)')
       for response_part in msg:
           if isinstance(response_part, tuple):
               email_message = email.message_from_bytes(response_part[1])
               print(email_message['From'])
               print(email_message['Subject'])
               print(email.utils.parsedate(email_message['Date']))

   mail.close()
   mail.logout()
   ```

3. **`yagmail` åº“**ï¼š

   `yagmail`æ˜¯ä¸€ä¸ªç®€åŒ–äº†å‘é€å’Œæ¥æ”¶é‚®ä»¶çš„Pythonåº“ã€‚å®ƒç®€åŒ–äº†ä½¿ç”¨SMTPå‘é€é‚®ä»¶å’ŒIMAPæ¥æ”¶é‚®ä»¶çš„è¿‡ç¨‹ï¼Œæä¾›äº†æ›´åŠ å‹å¥½çš„APIã€‚

   ç¤ºä¾‹ä»£ç ï¼š

   ```python
   import yagmail

   yag = yagmail.SMTP('sender@example.com', 'password')
   contents = ['This is the body of the email', '/path/to/attachment.pdf']
   yag.send('recipient@example.com', 'Subject', contents)
   yag.close()
   ```

   `yagmail`åº“ä¼šå¤„ç†SMTPæœåŠ¡å™¨çš„è¿æ¥å’Œé‚®ä»¶å‘é€ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æ–¹ä¾¿åœ°æ·»åŠ é™„ä»¶ã€‚

è¿™äº›åº“æä¾›äº†ä¸åŒçš„åŠŸèƒ½å’Œçµæ´»æ€§ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚é€‰æ‹©åˆé€‚çš„åº“æ¥æ“ä½œé‚®ä»¶ã€‚

### ç­›é€‰å‘ç¥¨é‚®ä»¶

è¿™é‡Œä¸€å¼€å§‹èµ°äº†ä¸€ç‚¹å¼¯è·¯ã€‚æœ€åˆçš„æƒ³æ³•æ˜¯é€šè¿‡ç¨‹åºç­›é€‰å‘ç¥¨é‚®ä»¶ï¼Œç„¶åå°†å‘ç¥¨é‚®ä»¶ç§»åŠ¨åˆ°"å‘ç¥¨"æ–‡ä»¶å¤¹ã€‚

ä½†æ˜¯è¿™æ ·æœ‰ä¸¤ä¸ªé—®é¢˜ï¼Œä¸€æ˜¯è¿™æ ·éœ€è¦è¯»å–å…¨éƒ¨é‚®ä»¶ï¼Œç­›é€‰å‡ºå‘ç¥¨é‚®ä»¶ï¼Œä¸ç¬¦åˆæœ€å°æƒé™åŸåˆ™ï¼Œç­›é€‰å®Œè¿˜éœ€è¦æŠŠéå‘ç¥¨é‚®ä»¶é‡æ–°æ ‡è®°ä¸ºâ€œæœªè¯»â€ï¼›äºŒæ˜¯ç§»åŠ¨åˆ°"å‘ç¥¨"æ–‡ä»¶å¤¹è¿™ä¸ªæ“ä½œçš„å…¼å®¹æ€§ä¸å¤ªå¥½ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰é‚®ç®±æœåŠ¡å•†éƒ½æ”¯æŒè¿™ä¸ªæ“ä½œã€‚

åæ¥æƒ³åˆ°å…¶å®é‚®ç®±éƒ½æœ‰è®¾ç½®æ”¶ä¿¡è§„åˆ™çš„åŠŸèƒ½ï¼Œå¯ä»¥è®¾ç½®ä¸€ä¸ªè§„åˆ™ï¼Œå°†æ”¶åˆ°çš„å‘ç¥¨é‚®ä»¶ç§»åŠ¨åˆ°"å‘ç¥¨"æ–‡ä»¶å¤¹ã€‚è¿™æ ·æˆ‘ä»¬å°±å®Œå…¨å¯ä»¥ç”¨è‡ªå·±å¸¸ç”¨çš„é‚®ç®±æ¥æ¥æ”¶å‘ç¥¨é‚®ä»¶ã€‚

> å»ºè®®è¿˜æ˜¯ç»™æ¥æ”¶å‘ç¥¨é‚®ä»¶å•ç‹¬è®¾ç½®ä¸€ä¸ªé‚®ç®±ã€‚

æœ‰äº†å‰é¢çš„åŸºç¡€ï¼Œç¨‹åºä¸­å°±åªéœ€è¦æ£€æŸ¥æŒ‡å®šçš„â€œå‘ç¥¨â€æ–‡ä»¶å¤¹ä¸­çš„é‚®ä»¶å°±å¥½äº†ã€‚

è¿™éƒ¨åˆ†åŠŸèƒ½è¢«å°è£…åˆ°`EmailClient`ç±»ä¸­ï¼š

```python
class EmailClient:
    def __init__(self, server, username, password):
        self.server = server
        self.username = username
        self.password = password
        self.client = None

    def connect(self):
        try:
            self.client = imapclient.IMAPClient(self.server, ssl=True)
            self.client.login(self.username, self.password)
            self.client.id_({"name": "IMAPClient", "version": "1.0.0"})
            return True
        except Exception as e:
            print(f"Failed to connect to the email server: {e}")
            return False

    def list_folders(self):
        if not self.client:
            print("Not connected to the email server. Call 'connect' method first.")
            return []

        folder_list = self.client.list_folders()
        return [folder_info[2] for folder_info in folder_list]

    def fapiao_folder_exists(self):
        if "å‘ç¥¨" in self.list_folders():
            return True
        else:
            print("'å‘ç¥¨'æ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º...")
            self.client.create_folder("å‘ç¥¨")
            print("å·²åˆ›å»º'å‘ç¥¨'æ–‡ä»¶å¤¹ï¼Œè¯·ç™»å½•é‚®ç®±åˆ›å»ºæ”¶ä¿¡è§„åˆ™ã€‚")
            return False

    def get_fapiao_emails(self, search_criteria=["UNSEEN"]):
        fapiao_emails = []

        if not self.client:
            print("Not connected to the email server. Call 'connect' method first.")
            return []

        self.client.select_folder("å‘ç¥¨")
        email_ids = self.client.search(search_criteria)

        for email_id in email_ids:
            email_message = self.fetch_email_content(email_id)
            decoded_subject = email.header.decode_header(email_message["Subject"])

            # åˆå§‹åŒ–ä¸€ä¸ªç©ºå­—ç¬¦ä¸²æ¥å­˜å‚¨è§£ç åçš„ä¸»é¢˜æ–‡æœ¬
            subject_text = ""

            # éå†è§£ç ç»“æœ
            for part, encoding in decoded_subject:
                # å¦‚æœç¼–ç ä¸ºNoneï¼Œåˆ™å‡å®šä½¿ç”¨UTF-8ç¼–ç 
                if encoding is None:
                    subject_text += part
                else:
                    # ä½¿ç”¨æŒ‡å®šç¼–ç è§£ç éƒ¨åˆ†
                    subject_text += part.decode(encoding, errors="ignore")

            # æ£€æŸ¥è§£ç åçš„ä¸»é¢˜æ–‡æœ¬æ˜¯å¦åŒ…å«"å‘ç¥¨"
            if "å‘ç¥¨" in subject_text:
                fapiao_emails.append([email_id, email_message])
            else:
                print(f"é‚®ä»¶ä¸»é¢˜ä¸åŒ…å«'å‘ç¥¨'ï¼Œå·²æ ‡è®°'æœªè¯»'ï¼Œè¯·ç™»å½•é‚®ç®±æ£€æŸ¥")
                print(f"email_id: {email_id}")
                print(f"email_subject: {subject_text}")
                print("-" * 80)
                self.set_email_unread(email_id)

        return fapiao_emails
```

ä»¥ä¸Šä»£ç å®šä¹‰äº†ä¸€ä¸ªåä¸º`EmailClient`çš„Pythonç±»ï¼Œç”¨äºè¿æ¥åˆ°é‚®ä»¶æœåŠ¡å™¨ï¼Œæ£€ç´¢ç‰¹å®šæ–‡ä»¶å¤¹ä¸­çš„æœªè¯»é‚®ä»¶ï¼Œå¹¶å†æ¬¡æ£€æŸ¥ä¸»é¢˜æ˜¯å¦åŒ…å«â€œå‘ç¥¨â€å…³é”®è¯ã€‚

1. **`__init__(self, server, username, password)`**:
   - è¿™æ˜¯ç±»çš„æ„é€ å‡½æ•°ï¼Œç”¨äºåˆå§‹åŒ–EmailClientå¯¹è±¡ã€‚å®ƒæ¥å—ä¸‰ä¸ªå‚æ•°ï¼š`server`ï¼ˆé‚®ä»¶æœåŠ¡å™¨åœ°å€ï¼‰ã€`username`ï¼ˆé‚®ç®±ç”¨æˆ·åï¼‰å’Œ`password`ï¼ˆé‚®ç®±å¯†ç ï¼‰ã€‚
   - å®ƒå°†è¿™äº›å‚æ•°å­˜å‚¨åœ¨ç±»çš„å®ä¾‹å˜é‡ä¸­ï¼Œä»¥ä¾¿åœ¨æ•´ä¸ªç±»ä¸­ä½¿ç”¨ã€‚

2. **`connect(self)`**:
   - è¿™ä¸ªæ–¹æ³•ç”¨äºè¿æ¥åˆ°é‚®ä»¶æœåŠ¡å™¨ã€‚å®ƒä½¿ç”¨`imapclient`åº“åˆ›å»ºäº†ä¸€ä¸ªIMAPå®¢æˆ·ç«¯è¿æ¥ï¼Œè¯¥è¿æ¥ä½¿ç”¨SSLåŠ å¯†ã€‚
   - å¦‚æœè¿æ¥æˆåŠŸï¼Œæ–¹æ³•è¿”å›`True`ï¼Œå¦åˆ™è¿”å›`False`ã€‚

3. **`list_folders(self)`**:
   - è¿™ä¸ªæ–¹æ³•ç”¨äºåˆ—å‡ºé‚®ç®±ä¸­çš„æ‰€æœ‰æ–‡ä»¶å¤¹ã€‚å®ƒé¦–å…ˆæ£€æŸ¥æ˜¯å¦å·²è¿æ¥åˆ°é‚®ä»¶æœåŠ¡å™¨ï¼Œå¦‚æœæ²¡æœ‰è¿æ¥ï¼Œå®ƒä¼šæ‰“å°ä¸€æ¡é”™è¯¯æ¶ˆæ¯å¹¶è¿”å›ä¸€ä¸ªç©ºåˆ—è¡¨ã€‚
   - å¦‚æœå·²è¿æ¥ï¼Œå®ƒä½¿ç”¨IMAPå®¢æˆ·ç«¯çš„`list_folders()`æ–¹æ³•è·å–æ–‡ä»¶å¤¹åˆ—è¡¨ï¼Œå¹¶è¿”å›è¿™äº›æ–‡ä»¶å¤¹çš„åç§°ã€‚

4. **`fapiao_folder_exists(self)`**:
   - è¿™ä¸ªæ–¹æ³•ç”¨äºæ£€æŸ¥æ˜¯å¦å­˜åœ¨åä¸ºâ€œå‘ç¥¨â€çš„æ–‡ä»¶å¤¹ã€‚å¦‚æœå­˜åœ¨ï¼Œå®ƒè¿”å›`True`ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œå®ƒå°è¯•åˆ›å»ºè¿™ä¸ªæ–‡ä»¶å¤¹ï¼Œå¹¶è¿”å›`False`ã€‚
   - å¦‚æœæ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œå®ƒä¼šæ‰“å°ä¸€æ¡æ¶ˆæ¯ï¼Œç„¶åä½¿ç”¨IMAPå®¢æˆ·ç«¯çš„`create_folder()`æ–¹æ³•åˆ›å»ºä¸€ä¸ªåä¸ºâ€œå‘ç¥¨â€çš„æ–‡ä»¶å¤¹ã€‚

5. **`get_fapiao_emails(self, search_criteria=["UNSEEN"])`**:
   - è¿™ä¸ªæ–¹æ³•ç”¨äºè·å–æœªè¯»é‚®ä»¶ä¸­ä¸»é¢˜åŒ…å«â€œå‘ç¥¨â€çš„é‚®ä»¶ã€‚å®ƒé¦–å…ˆæ£€æŸ¥æ˜¯å¦å·²è¿æ¥åˆ°é‚®ä»¶æœåŠ¡å™¨ï¼Œå¦‚æœæ²¡æœ‰è¿æ¥ï¼Œå®ƒä¼šæ‰“å°ä¸€æ¡é”™è¯¯æ¶ˆæ¯å¹¶è¿”å›ä¸€ä¸ªç©ºåˆ—è¡¨ã€‚
   - å¦‚æœå·²è¿æ¥ï¼Œå®ƒé€‰æ‹©â€œå‘ç¥¨â€æ–‡ä»¶å¤¹ï¼Œå¹¶ä½¿ç”¨IMAPå®¢æˆ·ç«¯çš„`search()`æ–¹æ³•è·å–æ»¡è¶³æŒ‡å®šæœç´¢æ¡ä»¶ï¼ˆé»˜è®¤ä¸ºæœªè¯»é‚®ä»¶ï¼‰çš„é‚®ä»¶IDã€‚
   - ç„¶åï¼Œå®ƒéå†è¿™äº›é‚®ä»¶ï¼Œè§£ç é‚®ä»¶ä¸»é¢˜ï¼Œå¹¶æ£€æŸ¥ä¸»é¢˜ä¸­æ˜¯å¦åŒ…å«â€œå‘ç¥¨â€å…³é”®è¯ã€‚å¦‚æœåŒ…å«ï¼Œå°†é‚®ä»¶çš„IDå’Œæ¶ˆæ¯å­˜å‚¨åœ¨ä¸€ä¸ªåˆ—è¡¨ä¸­ï¼Œå¹¶è¿”å›è¿™ä¸ªåˆ—è¡¨ã€‚
   - å¦‚æœä¸»é¢˜ä¸åŒ…å«â€œå‘ç¥¨â€ï¼Œå®ƒä¼šå°†é‚®ä»¶æ ‡è®°ä¸ºâ€œæœªè¯»â€çŠ¶æ€ï¼Œç„¶åæ‰“å°ä¸€æ¡æ¶ˆæ¯ã€‚

### ä¸‹è½½å‘ç¥¨

è·å–å‘ç¥¨é‚®ä»¶çš„å†…å®¹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯å¯¹å‘ç¥¨å†…å®¹è¿›è¡Œè§£æï¼Œæ‰¾åˆ°å‘ç¥¨æ–‡ä»¶å¹¶ä¸‹è½½ã€‚

è¿™é‡Œå¿…é¡»åæ§½ä¸‹ï¼Œä¸åŒå•†å®¶çš„å‘ç¥¨é‚®ä»¶çœŸçš„æ˜¯äº”èŠ±å…«é—¨ï¼Œé‚®ä»¶å†…å®¹æ ¼å¼å„æœ‰ç‰¹è‰²ã€‚å…¶å®ä¹Ÿæ˜¯å¸¦ç»™æˆ‘ä»¬ä¸€äº›æ€è€ƒï¼Œåƒç±»ä¼¼å‘ç¥¨è¿™ç§ç¥¨æ®ï¼Œåº”è¯¥ä»æ”¿åºœæˆ–è¡Œä¸šå±‚é¢å‡ºå°ç»Ÿä¸€æ ‡å‡†ï¼Œè§„å®šå¥½æ•°æ®äº¤æ¢æ ¼å¼ï¼Œè¿™æ ·æ‰èƒ½æœ€å¤§åŒ–æ•°æ®æµé€šæ•ˆç‡ã€‚å½“ç„¶äº†ï¼Œæ ‡å‡†çš„åˆ¶å®šé€šå¸¸æ˜¯æ»åè¡Œä¸šå‘å±•çš„ï¼Œæ¬§ç¾å‘è¾¾ç»æµä½“é‚£ä¹ˆæ ‡å‡†ä½“ç³»é‚£ä¹ˆå¥å…¨ï¼Œä¾ç„¶æœ‰å¤§é‡ä¼ä¸šä½¿ç”¨è‡ªå®šä¹‰æ ¼å¼ï¼Œå¯¼è‡´æ•°æ®äº¤æ¢æ•ˆç‡ä½ä¸‹ã€‚è¿™å°±åªèƒ½é å…¨ç¤¾ä¼šä¸€èµ·åŠªåŠ›äº†ï¼Œå°½æ—©å®ç°æ ‡å‡†åŒ–ã€ç³»ç»ŸåŒ–ã€‚

ç›®å‰ä¸‹è½½å‘ç¥¨ä½¿ç”¨äº†ä¸‹é¢3ä¸­è§£æç­–ç•¥ï¼š

1. ä»¥é™„ä»¶å‘é€å‘ç¥¨pdfæ–‡ä»¶çš„é‚®ä»¶æœ€å¥½å¤„ç†ï¼Œè¿™ä¸ªç¬¦åˆé‚®ä»¶æ ‡å‡†ï¼Œä¸ç®¡æ­£æ–‡è¯´äº†å•¥ï¼Œæˆ‘ä»¬ç›´æ¥ä¸‹è½½pdfé™„ä»¶å°±å¥½äº†ã€‚
2. æ²¡æœ‰pdfæ–‡ä»¶é™„ä»¶çš„é‚®ä»¶ï¼Œéœ€è¦è§£ææ­£æ–‡ä¸­çš„é“¾æ¥ï¼Œæ‰¾åˆ°pdfæ–‡ä»¶é“¾æ¥ï¼Œç„¶åä¸‹è½½ã€‚
3. æœ€å‘çš„å°±æ˜¯æ­£æ–‡ä¸­çš„é“¾æ¥è¿ä¸‹è½½é“¾æ¥éƒ½ä¸æ˜¯ï¼Œè€Œæ˜¯ä¸€ä¸ªç‰ˆå¼æ–‡ä»¶é¢„è§ˆï¼Œç„¶åè¿˜å¾—æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®ä¸‹è½½ã€‚è¿™ç§ç›®å‰å°±åªèƒ½æµè§ˆå™¨æ‰“å¼€é“¾æ¥ï¼Œæ¨¡æ‹Ÿç‚¹å‡»ä¸‹è½½æŒ‰é’®äº†ã€‚è¿™ä¸ªè¿‡ç¨‹å¯èƒ½éœ€è¦äººå·¥å¹²é¢„ã€‚

ä¸‹è½½äº†å‘ç¥¨pdfæ–‡ä»¶åå°±æ¯”è¾ƒå¥½åŠäº†ï¼ŒæŠŠä»–ä»¬å­˜åˆ°å¯¹åº”æ–‡ä»¶å¤¹å°±å¥½ï¼ŒæŒ‰ç…§æ—¥æœŸæ•´ç†åˆ°å¯¹åº”"å¹´ä»½/æœˆä»½"æ–‡ä»¶å¤¹ã€‚

å‘ç¥¨ä¸‹è½½è¢«å°è£…åˆ°`FapiaoDownloader`è¿™ä¸ªç±»ï¼š

```python
class FapiaoDownloader:
    def __init__(
        self,
        download_dir=os.path.abspath(
            os.path.join(os.path.dirname(__file__), "../fapiao")
        ),
    ):
        # åˆ›å»ºè¾“å‡ºç›®å½•

        if not os.path.exists(download_dir):
            os.makedirs(download_dir)

        self.download_dir = download_dir

    def download_fapiao(self, fapiao_emails):
        fapiao_pdfs = []
        for fapiao_email in fapiao_emails:
            # 'Mon, 9 Oct 2023 17:05:39 +0800'
            fapiao_email_date_str = decode_header(fapiao_email[1]["Date"])[0][0]
            fapiao_email_date = datetime.strptime(
                fapiao_email_date_str, "%a, %d %b %Y %H:%M:%S %z"
            )
            fapiao_email_month = fapiao_email_date.strftime("%Y/%m")
            download_dir = os.path.abspath(os.path.join(self.download_dir, fapiao_email_month))
            if not os.path.exists(download_dir):
                os.makedirs(download_dir)

            # è§£æé‚®ä»¶é™„ä»¶
            pdf_attachments = self._download_attachments(
                fapiao_email, download_dir, fapiao_email_date
            )
            if pdf_attachments:
                # é‚®ä»¶åŒ…å«é™„ä»¶ï¼Œè·³è¿‡è§£æé‚®ä»¶æ­£æ–‡
                fapiao_pdfs.extend(pdf_attachments)
                continue
            pdfs = self._download_url(fapiao_email, download_dir, fapiao_email_date)
            if pdfs:
                fapiao_pdfs.extend(pdfs)

        return fapiao_pdfs
```

ä¸‹è½½åçš„æ•ˆæœï¼š

![å‘ç¥¨PDFæ–‡ä»¶](https://imgs.boringhex.top/blog/20231013112940.png)

## æœªæ¥è·¯çº¿

è¿™ä¸ªå°å·¥å…·çš„ä»£ç é‡ä¸å¤§ï¼Œä½†æ˜¯å·²ç»åŸºæœ¬å¯ä»¥æ»¡è¶³æˆ‘çš„éœ€æ±‚äº†ã€‚

æœªæ¥ä¸»è¦çš„æ›´æ–°æ–¹å‘æœ‰3ä¸ªï¼š

1. è·Ÿè¿›å‘ç¥¨æ”¹é©ï¼Œé€‚åº”æ–°æ”¿ç­–ï¼Œæ¯”å¦‚å³å°†å…¨é¢å®æ–½çš„å…¨ç”µå‘ç¥¨ã€‚
2. å‡å°‘æ¼æ”¶æ¼ä¸‹ï¼Œæé«˜å‘ç¥¨ä¸‹è½½çš„å‡†ç¡®æ€§å’ŒæˆåŠŸç‡ã€‚
3. å¢åŠ å‘ç¥¨ä¿¡æ¯æå–åŠŸèƒ½ï¼Œæå–å‘ç¥¨ä¸­çš„å…³é”®ä¿¡æ¯ï¼Œæ¯”å¦‚å‘ç¥¨é‡‘é¢ã€å‘ç¥¨æ—¶é—´ã€å‘ç¥¨ç±»å‹ã€å‘ç¥¨æŠ¬å¤´ç­‰ã€‚è¿™ä¸ªåŠŸèƒ½å¯¹ä¸ªäººæ„ä¹‰ä¸å¤§ï¼Œä½†å¯ä»¥ç”¨äºä¼ä¸šå‘ç¥¨ç®¡ç†ï¼Œæ¯”å¦‚å‘ç¥¨åˆ°æœŸæé†’ã€å‘ç¥¨é‡‘é¢ç»Ÿè®¡ç­‰ã€‚è‰¯å¥½çš„è´¢åŠ¡å®è·µå¿…è¦è¦æ±‚è§„èŒƒçš„ç¥¨æ®ç®¡ç†ï¼ŒåŒæ—¶è¿˜è¦ç§¯æå¤„ç†æµç¨‹ä¸­çš„æ•°æ®è¦ç´ ã€‚

## è·å–æ–¹å¼

1. æ— ç—›ä½¿ç”¨å¯ç§»æ­¥ [å‘ç¥¨è‡ªåŠ¨ä¸‹è½½æ•´ç†æœºå™¨äºº](https://mp.weixin.qq.com/s?__biz=MzA3NzMyNTIyOA==&mid=2651481990&idx=1&sn=144046ff67c4e38af68fadff3202848e&chksm=84ad7145b3daf85365e9425483dea8ddbcd22191078cc700e788da61ff6d2196ba447944f83d#rd)
2. è´¡çŒ®æºç å¯è®¿é—® [githubä»“åº“](https://github.com/pengwon/fapiao_bot)

## é¢˜å¤–ï¼šfapiao vs invoice

å› ä¸ºå›½å†…çš„å‘ç¥¨å’Œå›½å¤–çš„invoiceæœ‰äº›ç»†èŠ‚ä¸Šçš„å·®åˆ«ï¼Œå¹¶ä¸å®Œå…¨ç­‰åŒï¼Œæ‰€ä»¥è¿™ä¸ªå°å·¥å…·çš„å‘½åä¸­æ²¡æœ‰ä½¿ç”¨invoiceï¼Œè€Œæ˜¯fapiaoğŸ˜€
